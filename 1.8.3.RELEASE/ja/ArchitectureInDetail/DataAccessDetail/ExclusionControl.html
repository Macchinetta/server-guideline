<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>6.3. 排他制御 &#8212; Macchinetta Server Framework (1.x) Development Guideline 1.8.3.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/solar.css?v=d41ac240" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=27499e11"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7. アプリケーション形態に依存しない汎用機能" href="../GeneralFuncDetail/index.html" />
    <link rel="prev" title="6.2. データベースアクセス（MyBatis3編）" href="DataAccessMyBatis3.html" /><script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../GeneralFuncDetail/index.html" title="7. アプリケーション形態に依存しない汎用機能"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. データベースアクセス（MyBatis3編）"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Server Framework (1.x) Development Guideline 1.8.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">6. </span>データアクセス</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.3. </span>排他制御</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox"> scroll sidebar</label>
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">6.3. 排他制御</a><ul>
<li><a class="reference internal" href="#overview">6.3.1. Overview</a><ul>
<li><a class="reference internal" href="#exclusioncontrol-necessity">6.3.1.1. 排他制御の必要性</a><ul>
<li><a class="reference internal" href="#problem1">6.3.1.1.1. Problem1</a></li>
<li><a class="reference internal" href="#problem2">6.3.1.1.2. Problem2</a></li>
<li><a class="reference internal" href="#problem3">6.3.1.1.3. Problem3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">6.3.1.2. トランザクションの分離レベルによる排他制御</a></li>
<li><a class="reference internal" href="#id5">6.3.1.3. データベースのロック機能による排他制御</a><ul>
<li><a class="reference internal" href="#id6">6.3.1.3.1. データベースの行ロック機能による排他制御</a></li>
<li><a class="reference internal" href="#id7">6.3.1.3.2. 楽観ロックによる排他制御</a></li>
<li><a class="reference internal" href="#id8">6.3.1.3.3. 悲観ロックによる排他制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">6.3.1.4. デッドロックの予防</a><ul>
<li><a class="reference internal" href="#dead-lock-record">6.3.1.4.1. テーブル内でのデッドロック</a></li>
<li><a class="reference internal" href="#dead-lock-table">6.3.1.4.2. テーブル間でのデッドロック</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.3.2. How to use</a><ul>
<li><a class="reference internal" href="#exclusioncontrolhowtousemybatis3">6.3.2.1. 排他制御の実装方法</a><ul>
<li><a class="reference internal" href="#rdbms">6.3.2.1.1. RDBMSの行ロック機能</a></li>
<li><a class="reference internal" href="#id13">6.3.2.1.2. 楽観ロック</a></li>
<li><a class="reference internal" href="#id14">6.3.2.1.3. 悲観ロック</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exclusioncontrolhowtouseexceptionhandling">6.3.2.2. 排他エラーのハンドリング方法</a><ul>
<li><a class="reference internal" href="#id16">6.3.2.2.1. 楽観ロックの失敗時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#id17">6.3.2.2.2. 悲観ロックの失敗時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="DataAccessMyBatis3.html"
                          title="previous chapter"><span class="section-number">6.2. </span>データベースアクセス（MyBatis3編）</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../GeneralFuncDetail/index.html"
                          title="next chapter"><span class="section-number">7. </span>アプリケーション形態に依存しない汎用機能</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/ExclusionControl.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="id1">
<h1><span class="section-number">6.3. </span>排他制御<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id20">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#exclusioncontrol-necessity" id="id21">排他制御の必要性</a></p>
<ul>
<li><p><a class="reference internal" href="#problem1" id="id22">Problem1</a></p></li>
<li><p><a class="reference internal" href="#problem2" id="id23">Problem2</a></p></li>
<li><p><a class="reference internal" href="#problem3" id="id24">Problem3</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id4" id="id25">トランザクションの分離レベルによる排他制御</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id26">データベースのロック機能による排他制御</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id27">データベースの行ロック機能による排他制御</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id28">楽観ロックによる排他制御</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id29">悲観ロックによる排他制御</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id9" id="id30">デッドロックの予防</a></p>
<ul>
<li><p><a class="reference internal" href="#dead-lock-record" id="id31">テーブル内でのデッドロック</a></p></li>
<li><p><a class="reference internal" href="#dead-lock-table" id="id32">テーブル間でのデッドロック</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id33">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#exclusioncontrolhowtousemybatis3" id="id34">排他制御の実装方法</a></p>
<ul>
<li><p><a class="reference internal" href="#rdbms" id="id35">RDBMSの行ロック機能</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id36">楽観ロック</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id37">悲観ロック</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#exclusioncontrolhowtouseexceptionhandling" id="id38">排他エラーのハンドリング方法</a></p>
<ul>
<li><p><a class="reference internal" href="#id16" id="id39">楽観ロックの失敗時のエラーハンドリング</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id40">悲観ロックの失敗時のエラーハンドリング</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">6.3.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>排他制御とは、複数のトランザクションから同じデータに対して、同時に更新処理が行われる際に、データの整合性を保つために行う処理のことである。</p>
<p>複数のトランザクションから同じデータに対して、同時に更新処理が行われる可能性がある場合は、基本的に排他制御を行う必要がある。
ここで言うトランザクションとは、かならずしもデータベースとのトランザクションとは限らず、ロングトランザクションも含まれる。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ロングトランザクションとは</strong></p>
<p>データの取得とデータの更新を、別々のデータベーストランザクションとして行う際に発生するトランザクションのことである。</p>
<p>具体例としては、取得したデータを編集画面に表示し、画面で編集した値をデータベースに更新するようなアプリケーションで発生する。</p>
</div>
<div class="line-block">
<div class="line">本節では、データベース上で管理されているデータに対する排他制御について、説明する。</div>
<div class="line">しかし、データベース以外で管理されているデータ(例えば、メモリ、ファイルなど)についても、同様に排他制御を行う必要があることに留意すること。</div>
</div>
<section id="exclusioncontrol-necessity">
<span id="id3"></span><h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">6.3.1.1. </span>排他制御の必要性</a><a class="headerlink" href="#exclusioncontrol-necessity" title="Permalink to this heading">¶</a></h3>
<p>まず、排他制御の必要性を理解してもらうために、排他制御を行わなかった際に発生する問題について、具体例を3つ挙げて説明する。</p>
<section id="problem1">
<h4><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">6.3.1.1.1. </span>Problem1</a><a class="headerlink" href="#problem1" title="Permalink to this heading">¶</a></h4>
<p>ここでは、ショッピングサイトにて、ユーザからTeaの注文を受け付ける場合の例を示す。</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/ExclusionControl-problem1.png"><img alt="Exclusive Control problem1" src="../../_images/ExclusionControl-problem1.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>UserA</p></th>
<th class="head"><p>UserB</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aが、商品画面にてTeaの在庫が5個あることを確認する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>User Bが、商品画面にてTeaの在庫が5個あることを確認する。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>User BがTeaを5個注文する。DB上のTeaの在庫を-5し、Teaの在庫は0になる。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User AがTeaを5個注文する。DB上のTeaの在庫を-5し、Teaの在庫は-5となる。</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><strong>User Aの注文は受け付けられたが、実際の在庫が無いため、謝りの連絡を入れることになる。</strong></div>
<div class="line"><strong>テーブルで管理しているTeaの在庫数についても、実際のTeaの在庫数と異なる値(マイナス値)になってしまう。</strong></div>
</div>
</div></blockquote>
</section>
<section id="problem2">
<h4><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">6.3.1.1.2. </span>Problem2</a><a class="headerlink" href="#problem2" title="Permalink to this heading">¶</a></h4>
<p>ここでは、ショッピングサイトでTeaの在庫数を管理するスタッフが、Teaの在庫数を表示し、仕入れたTeaの数をクライアントで計算して、Teaの在庫数を更新する場合の例を示す。</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/ExclusionControl-problem2.png"><img alt="Exclusive Control problem2" src="../../_images/ExclusionControl-problem2.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>UserA</p></th>
<th class="head"><p>UserB</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff AがTeaの在庫が5個あることを確認する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Staff BがTeaの在庫が5個あることを確認する。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Staff BがTeaを10個仕入れ、在庫数をクライアントで5＋10=15個と計算して更新する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff AがTeaを20個仕入れ、在庫数をクライアントで5＋20=25個と計算して更新する。</p></td>
</tr>
</tbody>
</table>
<p><strong>3の処理で追加した10個の仕入れが無くなってしまい、実際の在庫数(35個)と合わなくなってしまう。</strong></p>
</div></blockquote>
</section>
<section id="problem3">
<h4><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">6.3.1.1.3. </span>Problem3</a><a class="headerlink" href="#problem3" title="Permalink to this heading">¶</a></h4>
<p>ここでは、バッチ処理によってロックされているデータに対して、オンライン処理で更新する例を示す。</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/ExclusionControl-problem4.png"><img alt="Exclusive Control problem4" src="../../_images/ExclusionControl-problem4.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>UserA</p></th>
<th class="head"><p>Batch</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Batchがテーブルの更新対象の該当行（ここでは仮に全ての行とする。）をロックし、他の処理で更新できないようにする。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aが更新情報を検索する。この時点でBatchはコミットされていないため、Batch更新前の情報が取得できる。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aが更新要求をするが、Batchにロックされているため、更新が待たされる。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Batchが処理を終えてロックを解放する。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aの待たされていた更新処理が、実行可能となり更新処理を実行する。</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><strong>User AはBatch終了を待たされた後に、更新処理を実行する。しかし、User Aの取得した元のデータは、Batchの更新前のデータであり、Batchで更新した情報を上書く可能性がある。</strong></div>
<div class="line"><strong>また、Batch時間はオンライン処理と比べると長いものが多く、ユーザが待たされる時間が長くなる。</strong></div>
</div>
</div></blockquote>
</section>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">6.3.1.2. </span>トランザクションの分離レベルによる排他制御</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><a class="reference internal" href="#exclusioncontrol-necessity"><span class="std std-ref">排他制御の必要性</span></a> で挙げた3つの問題をすべて解決するための最も簡単な方法は、データベースへの処理を一つひとつ順番に（シリアルに）実行されるようにすることである。</div>
<div class="line">このようにシリアルに処理させることで、トランザクションが互いに影響を及ぼし合わなくなる。</div>
<div class="line">しかしながら、シリアルに処理させる場合、単位時間内に実行可能なトランザクション数が減少するため、パフォーマンスが低下することになる。</div>
</div>
<p>ANSI/ISO SQL標準では、トランザクションの分離レベル（各トランザクションがそれぞれどの程度互いに影響を及ぼし合うか）を表す指標を定義している。
以下に、トランザクションの分離レベルを4つ示す。併せて、各分離レベルで起こりうる現象について説明する。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11.1%" />
<col style="width: 22.2%" />
<col style="width: 22.2%" />
<col style="width: 22.2%" />
<col style="width: 22.2%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">分離レベル</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">ダーティ・リード</div>
<div class="line">DRITY READ</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">再読込不可能読取</div>
<div class="line">NON-REPEATABLE READ</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">ファントム・リード</div>
<div class="line">PHANTOM READ</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">未コミット読込</div>
<div class="line">READ UNCOMMITTED</div>
</div>
</td>
<td><p>有</p></td>
<td><p>有</p></td>
<td><p>有</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コミット済読込</div>
<div class="line">READ COMMITTED</div>
</div>
</td>
<td><p>無</p></td>
<td><p>有</p></td>
<td><p>有</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">再読込可能読取</div>
<div class="line">REPEATABLE READ</div>
</div>
</td>
<td><p>無</p></td>
<td><p>無</p></td>
<td><p>有</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">直列化</div>
<div class="line">SERIALIZABLE</div>
</div>
</td>
<td><p>無</p></td>
<td><p>無</p></td>
<td><p>無</p></td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>ダーティ・リード（DRITY READ）</strong></p>
<p>まだコミットされていないトランザクションが書き込んだデータを、別のトランザクションが読み込む現象のことである。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>再読込不可能読取（NON-REPEATABLE READ）</strong></p>
<p>同一トランザクション内で同じレコードを2度読み込むような場合、1度目と2度目の読み込みの間に他トランザクションがコミットすると、1度目に読み込んだ内容と2度目に読み込んだ内容が異なる可能性がある。
複数回の読み込みの結果が、他のトランザクションのコミットのタイミングによって変わることである。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>ファントム・リード（PHANTOM READ）</strong></p>
<p>同一トランザクション内で、同じレコードを2回読み込む間に、他のトランザクションがレコードを追加、または削除することにより、2回目の読み込みで1回目と取得レコード数（内容）が異なることである。</p>
</div>
<div class="line-block">
<div class="line">上記の表に定義されている分離レベルは、下にいくほどトランザクションの分離レベルが高くなる。</div>
<div class="line">分離レベルが高ければ、データは安全に守られるが、ロック待ちが多くなり、パフォーマンスが低下する。</div>
<div class="line">SERIALIZABLEは、アクセス頻度がかなり低い場合を除き、選択すべきでない。</div>
<div class="line">その理由は、SELECTを含め、すべてのデータアクセスが、一つずつ順番に行われるためである。</div>
</div>
<div class="line-block">
<div class="line">トランザクション間の分離性と同時実行性は、トレードオフの関係である。</div>
<div class="line">すなわち、分離レベルを高くすれば同時実効性が下がり、分離レベルを下げると、同時実効性が上がる。</div>
<div class="line">そのため、アプリケーションの要件に合わせて、トランザクションの分離性と同時実行性のバランスをとる必要がある。</div>
</div>
<div class="line-block">
<div class="line">使用するデータベースにより、サポートされている分離レベルは違うため、使用するデータベースの特性を理解する必要がある。</div>
<div class="line">以下に、データベース毎でサポートされている分離レベルと、デフォルト値を示す。</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 11.1%" />
<col style="width: 22.2%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">データベース</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">READ UNCOMMITTED</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">READ COMMITTED</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">REPEATABLE READ</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">SERIALIZABLE</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Oracle</div>
</div>
</td>
<td><div class="line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇(default)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">PostgreSQL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇(default)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DB2</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇(default)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">MySQL InnoDB</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇(default)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>データの整合性を保ちつつ、分離性と同時実行性のバランスをとる場合、データベースのロック機能を使用して排他制御を行う必要がある。以下に、データベースのロック機能について説明する。</strong></p>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">6.3.1.3. </span>データベースのロック機能による排他制御</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">更新対象のデータを適切な方法でロックする必要がある。その理由は、下記2点の通りである。</div>
</div>
<ul class="simple">
<li><p>データベース上で管理されているデータの整合性を保つため</p></li>
<li><p>更新処理が競合しないようにするため</p></li>
</ul>
<div class="line-block">
<div class="line">データベース上で管理されているデータをロックする方法は、下記の通り3種類ある。</div>
<div class="line">アーキテクトは、これらのロックの特徴を十分に理解した上で、アプリケーションの特性にあったロックの方法を採用すること。</div>
</div>
<blockquote>
<div><table class="docutils align-default" id="id18">
<caption><span class="caption-text">ロックの種類</span><a class="headerlink" href="#id18" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10.0%" />
<col style="width: 15.0%" />
<col style="width: 40.0%" />
<col style="width: 35.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>ロック種類</p></th>
<th class="head"><p>適用ケース</p></th>
<th class="head"><p>特徴</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>RDBMSによる自動的なロック</p></td>
<td><ul class="simple">
<li><p>データの更新条件として、データの整合性を保証するために必要な条件を指定できる場合。</p></li>
<li><p>同一データに対する同時実行数が少なく、更新処理も短い時間でおわる場合。</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>チェックと更新処理を一つのSQLで実行するため、効率的である。</p></li>
<li><p>楽観ロックに比べ、データの整合性を保証するための条件を個別に検討する必要がある。</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>楽観ロック</p></td>
<td><ul class="simple">
<li><p>事前に取得したデータが他のトランザクションによって更新されていた場合に、更新内容を確認させる必要がある場合。</p></li>
<li><p>同一データに対する同時実行数が少なく、更新処理も短い時間でおわる場合。</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>取得したデータに対して、他のトランザクションからの更新が行われていないことが保証される。</p></li>
<li><p>テーブルにVersionを管理するためのカラムを定義する必要がある。</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>悲観ロック</p></td>
<td><ul class="simple">
<li><p>長い時間ロックされる可能性があるデータに対して更新する場合。</p></li>
<li><p>楽観ロックが使用できない(Versionを管理するためのカラムが定義できない)ため、処理としてデータの整合性チェックを行う必要がある場合。</p></li>
<li><p>同一データに対する同時実行数が多く、更新処理も長い時間実行される可能性がある場合。</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>他のトランザクションの処理結果によって処理が失敗する可能性がなくなる。</p></li>
<li><p>悲観ロックを取得するためのselect文を発行する必要があるので、その分コストがかかる。</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ロックの種類の採用基準について</strong></p>
<p>どの手法を採用するかについて、アーキテクトが、機能要件および性能要件を考慮して決定すること。</p>
<ul class="simple">
<li><p>画面にデータを戻し、画面上でデータを変更するような、データベースとのトランザクションが切れて、次のトランザクションでデータが変わっていないことを保証するためには、楽観ロックが必要となる。</p></li>
<li><p>1トランザクション内でロックをかける必要がある場合は、悲観ロックと楽観ロックの両方で実現できるが、悲観ロックを使用した場合、データベース内のロック制御処理が行われるため、データベース内の処理コストが高くなる可能性がある。特に問題がない場合は、楽観ロックの方がよい。</p></li>
<li><p>更新頻度が高い処理で、1トランザクション内で多くのテーブルを更新する場合は、楽観ロックを使用すると、ロックを取得するための待ち時間は最小限に抑えることが出できるが、途中で排他エラーとなる可能性があるため、エラーが発生するポイントが増える。
悲観ロックを使用すると、ロックを取得するまでの待ち時間が長くなる可能性はあるが、ロックを取得した後の処理で排他エラーが発生することはないため、エラーが発生するポイントが減る。</p></li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>業務トランザクションについて</strong></p>
<p>実際のアプリケーション開発では、業務フローレベルのトランザクションに対して、排他制御が必要になる場合もある。
業務フローレベルのトランザクションとなる代表例としては、旅行代理店のカウンタで、お客様と話をしながら予約作業を進めていく際に使用するアプリケーションがあげられる。</p>
<p>旅行予約を行う場合、鉄道、宿泊施設、さらに追加プランなどを話しながら決めていくことになる。
その際に、予約することに決めた宿泊施設や追加プランが、他の利用者に予約されないようにする仕組みが必要になる。
このような場合は、テーブルにステータスを持たせ、仮予約 -&gt; 予約 のように更新し、仮予約中の場合も、他の利用者から更新されないようにする必要がある。</p>
<p>業務トランザクションに対する排他制御については、業務設計や機能設計として検討・設計すべき箇所になるので、本節の説明範囲からは省いている。</p>
</div>
<section id="id6">
<h4><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">6.3.1.3.1. </span>データベースの行ロック機能による排他制御</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">ほとんどのデータベースでは、レコードを更新（UPDATE,DELETE）した場合、コミットまたはロールバックされるまで、他のトランザクションからの更新を待機させるための行ロックが取得される。</div>
<div class="line">そのため、更新件数が想定通りであれば、データの整合性を保証することができる。</div>
</div>
<div class="line-block">
<div class="line">この特性を活かし、更新時のWHERE句に対して、データの整合性を担保するための条件を指定することで、排他制御を行うことができる。</div>
<div class="line">以下に、データベース毎の、更新時の行ロックのサポート状況を示す。</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 11.1%" />
<col style="width: 22.2%" />
<col style="width: 11.1%" />
<col style="width: 16.7%" />
<col style="width: 38.9%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>データベース</p></th>
<th class="head"><p>確認Version</p></th>
<th class="head"><p>デフォルト設定時のロック</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>Oracle</p></td>
<td><p>11</p></td>
<td><p>行ロック</p></td>
<td><p>ロック分メモリ使用量が増大する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>PostgreSQL</p></td>
<td><p>9</p></td>
<td><p>行ロック</p></td>
<td><p>メモリ上に変更された行の情報を記憶しないので、同時にロックできる行数に、上限はない。ただし、テーブルに書き込むため、定期的にVACUUMしなければならない。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>DB2</p></td>
<td><p>9</p></td>
<td><p>行ロック</p></td>
<td><p>ロック分メモリ使用量が増大する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>MySQL InnoDB</p></td>
<td><p>5</p></td>
<td><p>行ロック</p></td>
<td><p>ロック分メモリ使用量が増大する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">データベースの行ロック機能による排他制御は、他のトランザクションによって更新した内容を確認する必要がない場合に使用することができる。</div>
<div class="line">例えば、ショッピングサイトの購入処理にて、購入した商品の個数を、商品の在庫数を管理するレコードからマイナスするような処理が挙げられる。</div>
<div class="line">ステータス管理を管理する処理などでは、前のステータスが重要になるので、この方法で排他制御を実現することを推奨しない。</div>
</div>
<p>以下に、具体例を示す。シナリオは、以下の通りである。</p>
<ul class="simple">
<li><p>ショッピングサイトでUser A,User Bともに同じ商品の購入画面を同時に表示する。
その際に、Stock Tableから取得した在庫数も表示されている。</p></li>
<li><p>買いたい商品を5個ずつ同時に購入したが、少しUserAの方が早く購入ボタンを押下したため、User Aが先に購入し、User Bが次に購入する。</p></li>
</ul>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/update-for-db-line-lock.png"><img alt="update for db line lock" src="../../_images/update-for-db-line-lock.png" style="width: 90%;" /></a>
</figure>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>UserA</p></th>
<th class="head"><p>UserB</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aが、商品の購入画面を表示する。在庫数が100個で画面に表示されている。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;01&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>User Bが、商品の購入画面を表示する。在庫数が100個で画面に表示されている。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;01&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aが、ItemId=01の商品を5個購入する。Stock Tableから個数を-5する。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Update</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span>
<span class="w">                      </span><span class="k">where</span><span class="w"> </span><span class="n">ItemId</span><span class="o">=</span><span class="s1">&#39;01&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>User Bが、ItemId=01の商品を5個購入する。Stock Tableから個数を-5しようとするが、User Aのトランザクションが終了していないので、User Bの購入処理が待たされる。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>User Aのトランザクションをコミットする。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><div class="line-block">
<div class="line">User Aのトランザクションがコミットされたため、4で待たされていたUserBの購入処理が再開する。</div>
<div class="line">この時、在庫は画面で見ると、個数は100ではなく、95になっているが、購入数(上記例では、5個)以上の在庫が残っているため、Stock Tableから個数を-5する。</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Update</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span>
<span class="w">                      </span><span class="k">where</span><span class="w"> </span><span class="n">ItemId</span><span class="o">=</span><span class="s1">&#39;01&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>User Bのトランザクションをコミットする。</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ポイント</strong></p>
<p>SQL内で減算( <code class="docutils literal notranslate"><span class="pre">quantity</span> <span class="pre">-</span> <span class="pre">5</span></code> )と、更新条件( <code class="docutils literal notranslate"><span class="pre">and</span> <span class="pre">quantity</span> <span class="pre">&gt;=</span> <span class="pre">5</span></code> )の指定を行うことが、ポイントとなる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">上と同じシナリオで、商品の購入画面を表示した際の在庫数が、9個だった場合、User Bの更新処理が再開した時点の在庫数が、4個のため、<code class="docutils literal notranslate"><span class="pre">quantity</span> <span class="pre">&gt;=</span> <span class="pre">5</span></code>を満たさないので、更新件数が0件となる。</div>
<div class="line">アプリケーションでは、更新件数が0件の場合、購入処理をロールバックし、User Bに再度実行を促す。</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/update-for-db-line-lock-not-enough.png"><img alt="update for db line lock not enough" src="../../_images/update-for-db-line-lock-not-enough.png" style="width: 90%;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ポイント</strong></p>
<p>アプリケーションで更新件数をチェックし、想定件数と異なる場合にエラーを発生させ、トランザクションをロールバックすることが、ポイントとなる。</p>
</div>
</div></blockquote>
<p><strong>この方法でロックする場合、参照した情報が変わっていても条件次第で処理を進めることができ、かつ、データベースの機能によってデータの整合性を保証することができる。</strong></p>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">6.3.1.3.2. </span>楽観ロックによる排他制御</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">楽観ロックとは、データそのものに対してロックは行わずに、更新対象のデータが、データ取得時と同じ状態であることを確認してから更新することで、データの整合性を保証する手法である。</div>
<div class="line">楽観ロックを使用する場合は、更新対象のデータが、データ取得時と同じ状態であることを判断するために、Versionを管理するためのカラム(Versionカラム)を用意する。</div>
<div class="line">更新時の条件として、データ取得時のVersionと、データ更新時のVersionを同じとすることで、データの整合性を保証することができる。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Versionカラムとは</strong></p>
<p>レコードの更新回数を管理するためのカラムで、レコード挿入時に0を設定し、更新成功時にインクリメントしていく楽観ロック用のカラムである。
Versionカラムは、数値以外に最終更新タイムスタンプで代用することもできる。
しかし、タイムスタンプを用いると、同時に処理が実行された際の、一意性が保証されない。
そこで、確実な一意性を求める場合、Versionカラムは、数値を使用する必要がある。</p>
</div>
<div class="line-block">
<div class="line">楽観ロックによる排他制御は、他のトランザクションによって更新されていた場合に、更新内容を確認させる必要がある場合に使用する。</div>
<div class="line">例えば、ワークフローアプリケーションにおいて、申請者と承認者が同時に操作（引き戻しと承認）を行った場合を想像してほしい。</div>
<div class="line">この時、楽観ロックによる排他制御を行うことで、操作の前後で状態が変わっているため、操作が完了しなかったことを、申請者と承認者に通知することができる。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>楽観ロックを行う場合、IDとVersion以外の条件を加えて更新・削除するのは適切でない。
なぜなら更新できなかった場合に、Versionが一致しないことが理由なのか、別の条件に一致しないのが理由なのか、判断できないためである。
更新条件として別の条件がある場合は、事前の処理として条件を満たしているか、チェックを行う必要がある。</p>
</div>
<p>具体例を、以下に示す。シナリオは、以下の通りである。</p>
<ul class="simple">
<li><p>ショッピングサイトの在庫数を管理するスタッフ(Staff A, Staff B)が、それぞれ商品を仕入れる。Staff Aが5個、Staff Bが15個仕入れたものとする。</p></li>
<li><p>仕入れた商品を、在庫管理システムに反映するために、在庫管理画面を表示する。その際、在庫管理システムで管理されている在庫数が表示される。</p></li>
<li><p>それぞれ表示された在庫数に対して、仕入れた数を加算した値を更新フォームに入力し、更新を行う。</p></li>
</ul>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Optimistic-lock-flow.png"><img alt="Optimistic lock flow" src="../../_images/Optimistic-lock-flow.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>Staff A</p></th>
<th class="head"><p>Staff B</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff Aが、商品の在庫管理画面を表示する。在庫数は10個と画面に表示されている。参照したデータのVersionは “<code class="docutils literal notranslate"><span class="pre">1</span></code>” である。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Staff Bが、商品の在庫管理画面を表示する。在庫数は10個と画面に表示されている。参照したデータのVersionは “<code class="docutils literal notranslate"><span class="pre">1</span></code>” である。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff Aが、画面に表示されていた在庫数10に対して、仕入れた5個を加算し、変更後の在庫数を15個で更新する。更新条件として、参照したデータのVersionを含める。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">             </span><span class="k">WHERE</span><span class="w"> </span><span class="n">itemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;01&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Staff Bが、画面に表示されていた在庫数10に対して仕入れた15個を加算し、変更後の在庫数を25個で更新しようとするが、Staff Aのトランザクションが終了していないので待たされる。更新条件として、参照したデータのVersionを含める。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff Aのトランザクションをコミットする。 <strong>この時点で、Versionは  2 になる。</strong></p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff Aのトランザクションがコミットされたため、4で待たされていたStaff Bの更新処理が再開する。この時、Stock TableのデータのVersionが “<code class="docutils literal notranslate"><span class="pre">2</span></code>” になっているため、更新結果が0件となる。更新結果が0件の場合は排他エラーとする。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">             </span><span class="k">WHERE</span><span class="w"> </span><span class="n">itemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;01&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Staff Bのトランザクションをロールバックする。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ポイント</strong></p>
<p>SQL内でVersionのインクリメント( <code class="docutils literal notranslate"><span class="pre">version</span> <span class="pre">+</span> <span class="pre">1</span></code> )と、更新条件( <code class="docutils literal notranslate"><span class="pre">and</span> <span class="pre">version</span> <span class="pre">=</span> <span class="pre">1</span></code> )の指定を行うことが、ポイントとなる。</p>
</div>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">6.3.1.3.3. </span>悲観ロックによる排他制御</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">悲観ロックとは、更新対象のデータを取得する際にロックをかけることで、他のトランザクションから更新されないようにする手法である。</div>
<div class="line">悲観ロックを使用する場合は、トランザクション開始直後に更新対象となるレコードのロックを取得する。</div>
<div class="line">ロックされたレコードは、トランザクションが、コミットまたはロールバックされるまで、他のトランザクションから更新されないため、データの整合性を保証することができる。</div>
</div>
<table class="docutils align-default" id="id19">
<caption><span class="caption-text">RDBMS別の悲観ロック取得方法</span><a class="headerlink" href="#id19" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 18.2%" />
<col style="width: 27.3%" />
<col style="width: 54.5%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>データベース</p></th>
<th class="head"><p>悲観ロック方法</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>Oracle</p></td>
<td><p>FOR UPDATE</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>PostgreSQL</p></td>
<td><p>FOR UPDATE</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>DB2</p></td>
<td><p>FOR UPDATE WITH</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>MySQL</p></td>
<td><p>FOR UPDATE</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>悲観ロックのタイムアウトについて</strong></p>
<p>悲観ロックには、悲観ロック取得時に他のトランザクションによってロックが取得されていた場合に、どのような動作にするかをオプションとして指定することがある。
Oracleの場合は、</p>
<ul class="simple">
<li><p>デフォルトでは、<code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">[wait]</span></code>となり、ロックが解除されるまで待つ。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">nowait</span></code>とすると、他にロックされている場合は、即時にリソースビジーのエラーとなる。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">wait</span> <span class="pre">5</span></code>とすると5秒待ち、5秒間ロックが解除されない場合は、リソースビジーのエラーが返却される。</p></li>
</ul>
<p>DBにより機能に差はあるが、悲観ロックを使用する際は、どの手法を採用するか検討が必要である。</p>
</div>
<p>悲観ロックによる排他制御は、以下3ケースのいずれかに当てはまる場合に使用する。</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line">更新対象のデータが複数のテーブルに分かれて管理されている。</div>
<div class="line">更新対象のテーブルが複数のテーブルに分かれている場合、各テーブルに対して更新が終わるまでの間に、他のトランザクションから更新がされないことを保証するために、必要となる。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">更新処理を行う前に取得したデータの状態をチェックする必要がある。</div>
<div class="line">チェック処理が終わった後に、他のトランザクションから更新がされていないことを保証するために、必要となる。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">バッチ実行中にオンラインの処理が実行されることがある。</div>
<div class="line">バッチ処理では、実行途中に排他エラーが発生しないようにするために、更新対象となるデータのロックを一括で取得することがある。</div>
<div class="line">一括で取得されたロックが取得された場合、オンラインの処理が待たされる時間が長くなる可能性がある。その場合、タイムアウト時間を指定して、悲観ロックを使用するのが妥当である。</div>
</div>
</li>
</ol>
<p>具体例を以下に示す。シナリオは、以下の通りである。</p>
<ul class="simple">
<li><p>バッチ処理が既に実行済みで、オンラインで更新するデータを悲観ロックしている。</p></li>
<li><p>オンライン処理は10秒のタイムアウト時間を指定して、更新対象のデータのロックを取得する。</p></li>
<li><p>バッチ処理は5秒後(タイムアウト前)に終了する。</p></li>
</ul>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Pessimistic-lock.png"><img alt="Pessimistic lock" src="../../_images/Pessimistic-lock.png" style="width: 90%;" /></a>
</figure>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>Online</p></th>
<th class="head"><p>Batch</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>バッチ処理が、オンライン処理で更新するデータの悲観ロックを取得する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>オンライン処理が、更新対象のデータの悲観ロックを行うが、バッチ処理のトランザクションによって悲観ロックされているので待たされる。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">WAIT</span><span class="w"> </span><span class="mi">10</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>バッチ処理が、データを更新する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>バッチ処理のトランザクションをコミットする。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>バッチ処理のトランザクションがコミットされたため、オンライン処理の処理が再開する。取得されるデータはバッチ処理の更新結果が反映されているので、データ不整合が発生することはない。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>オンライン処理が、データを更新する。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>オンライン処理のトランザクションをコミットする。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">以下は、タイムアウトとなった場合の流れとなる。</div>
<div class="line">バッチ処理の終了まで待たずに排他エラーとなる。</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Pessimistic-lock-timeout.png"><img alt="Pessimistic lock" src="../../_images/Pessimistic-lock-timeout.png" style="width: 90%;" /></a>
</figure>
</div></blockquote>
<div class="line-block">
<div class="line">以下は、悲観ロックの取得待ちを行わない設定のとき、他のトランザクションによって、悲観ロックが取得されていた場合の流れとなる。</div>
<div class="line">悲観ロックの解放を待つことなく、すぐに排他エラーとなる。</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Pessimistic-lock-nowait.png"><img alt="Pessimistic lock" src="../../_images/Pessimistic-lock-nowait.png" style="width: 90%;" /></a>
</figure>
</div></blockquote>
<p><strong>バッチ処理とオンライン処理が競合する可能性があり、かつバッチ処理の処理時間が長くなる場合は、悲観排他のタイムアウト時間を指定することを推奨する。</strong>
<strong>タイムアウト時間については、オンライン処理の処理要件に応じて決めること。</strong></p>
</section>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">6.3.1.4. </span>デッドロックの予防</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">データベースのロック機能を使用する場合、同一トランザクション内で複数のレコードを更新すると、以下2通りの、デッドロックが発生する可能性があるため、注意する必要がある。</div>
</div>
<ul class="simple">
<li><p><a class="reference internal" href="#dead-lock-record"><span class="std std-ref">テーブル内でのデッドロック</span></a></p></li>
<li><p><a class="reference internal" href="#dead-lock-table"><span class="std std-ref">テーブル間でのデッドロック</span></a></p></li>
</ul>
<section id="dead-lock-record">
<span id="id10"></span><h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">6.3.1.4.1. </span>テーブル内でのデッドロック</a><a class="headerlink" href="#dead-lock-record" title="Permalink to this heading">¶</a></h4>
<p>以下(1)～(5)の流れで、複数のトランザクションから、同一テーブルのレコードに対してロックを行うと、デッドロックとなる。</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Dead-Lock-Record.png"><img alt="Dead Lock Record" src="../../_images/Dead-Lock-Record.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>Program A</p></th>
<th class="head"><p>Program B</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Aは、Record X に対するロックを取得する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Bは、Record Y に対するロックを取得する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Aは、Program BのトランザクションによってロックされているRecord Y に対してロックの取得を試みるが、(2)のロック状態が解放されていないので、解放待ちの状態となる。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Program Bは、Program AのトランザクションによってロックされているRecord X に対してロックの取得を試みるが、(1)のロック状態が解放されていないので、解放待ちの状態となる。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>-</p></td>
<td><p>-</p></td>
<td><p>Program AとProgram Bが、お互いに保持しているロックに対して解放待ちの状態となるため、デッドロックとなる。デッドロックが発生した場合、データベースによって検知されエラーとなる。</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>デッドロックの解決方法について</strong></p>
<p>タイムアウトやリトライ実施での解消する方法もあるが、同一テーブル上でのレコードの更新順序にルールを決めることが重要である。
1行ずつ更新する場合は、PK(PRIMARY KEY)順の若い順に更新するなどのルールを定めること。</p>
<p>仮にProgram AもProgram BもRecord Xから更新するというルールに準じていれば、上記<a class="reference internal" href="#dead-lock-record"><span class="std std-ref">テーブル内でのデッドロック</span></a>の図のようなデッドロックは発生しなくなる。</p>
</div>
</div></blockquote>
</section>
<section id="dead-lock-table">
<span id="id11"></span><h4><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">6.3.1.4.2. </span>テーブル間でのデッドロック</a><a class="headerlink" href="#dead-lock-table" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">以下(1)～(5)の流れで、複数のトランザクションから、別テーブルのレコードに対してロックを行うと、デッドロックとなる。</div>
<div class="line">基本的な考え方は、 <a class="reference internal" href="#dead-lock-record"><span class="std std-ref">テーブル内でのデッドロック</span></a> と同じである。</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/Dead-Lock-Table.png"><img alt="Dead Lock Table" src="../../_images/Dead-Lock-Table.png" style="width: 90%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 5.0%" />
<col style="width: 5.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>Program A</p></th>
<th class="head"><p>Program B</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Aは、Table A の Record X に対するロックを取得する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Bは、Table B の Record Y に対するロックを取得する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>〇</p></td>
<td><p>-</p></td>
<td><p>Program Aは、Program BのトランザクションによってロックされているTable B の Record Y に対してロックの取得を試みるが、(2)のロック状態が解放されていないので、解放待ちの状態となる。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>-</p></td>
<td><p>〇</p></td>
<td><p>Program Bは、Program AのトランザクションによってロックされているTable A の Record X に対してロックの取得を試みるが、(1)のロック状態が解放されていないので、解放待ちの状態となる。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>-</p></td>
<td><p>-</p></td>
<td><p>Program AとProgram Bが、お互いに保持しているロックに対して解放待ちの状態となるため、デッドロックとなる。デッドロックが発生した場合、データベースによって検知されエラーとなる。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>デッドロックの解決方法について</strong></p>
<p>タイムアウトやリトライ実施での解消する方法もあるが、テーブルを跨った際も、更新順序をルール化しておくことが重要である。</p>
<p>仮にProgram AもProgram BもTable Aから更新するというルールに準じていれば、上記<a class="reference internal" href="#dead-lock-table"><span class="std std-ref">テーブル間でのデッドロック</span></a>の図のような、デッドロックは発生しなくなる。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>注意としては、どの方法を採用したとしても、レコードをロックする順序により、デッドロックが発生する可能性がある。
テーブル、レコードのロック順序については、ルールを決めること。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">6.3.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<p>ここからは、MyBatis3を使用した排他制御の実現方法について説明を行う。</p>
<p>実装方法は</p>
<ul class="simple">
<li><p><a class="reference internal" href="#exclusioncontrolhowtousemybatis3"><span class="std std-ref">排他制御の実装方法</span></a></p></li>
</ul>
<p>を確認されたい。</p>
<p>また、排他エラーのハンドリング方法については、</p>
<ul class="simple">
<li><p><a class="reference internal" href="#exclusioncontrolhowtouseexceptionhandling"><span class="std std-ref">排他エラーのハンドリング方法</span></a></p></li>
</ul>
<p>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="exclusioncontrolhowtousemybatis3">
<span id="id12"></span><h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">6.3.2.1. </span>排他制御の実装方法</a><a class="headerlink" href="#exclusioncontrolhowtousemybatis3" title="Permalink to this heading">¶</a></h3>
<section id="rdbms">
<h4><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">6.3.2.1.1. </span>RDBMSの行ロック機能</a><a class="headerlink" href="#rdbms" title="Permalink to this heading">¶</a></h4>
<p>RDBMSの行ロック機能を使って排他制御を行う場合は、SQLの中で、</p>
<ul class="simple">
<li><p>SET句に指定する更新内容</p></li>
<li><p>WHERE句に指定する更新条件</p></li>
</ul>
<p>を意識する必要がある。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>Repositoryインタフェースにメソッドを定義する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StockRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">decrementQuantity</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;itemCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemCode</span><span class="p">,</span>
<span class="w">                              </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;quantity&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">quantity</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Repositoryインタフェースに、
RDBMSの行ロック機能を使ってデータを更新するメソッドを定義する。</p>
<p>上記例では、在庫数を減らすためのメソッドを定義している。
在庫数の減らす事ができた場合は、<code class="docutils literal notranslate"><span class="pre">true</span></code>が返却される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>RDBMSの行ロック機能を使った排他制御が有効となるSQLを定義する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;decrementQuantity&quot;</span><span class="nt">&gt;</span>
<span class="cp">&lt;![CDATA[</span>
<span class="cp">    UPDATE</span>
<span class="cp">        m_stock</span>
<span class="cp">    SET</span>
<span class="cp">        /* (3) */</span>
<span class="cp">        quantity = quantity - #{quantity}</span>
<span class="cp">    WHERE</span>
<span class="cp">        item_code = #{itemCode}</span>
<span class="cp">    AND</span>
<span class="cp">        /* (4) */</span>
<span class="cp">        quantity &gt;= #{quantity}</span>
<span class="cp">]]&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>RDBMSの行ロック機能を使ってデータを更新するためのステートメント(SQL)を定義する。</p>
<p>上記例では、在庫数を減らすためのSQLを定義している。</p>
<p>RDBMSの行ロック機能を使う場合は、</p>
<ul class="simple">
<li><p>他のトランザクションが同一データに対してロックを取得している場合は、
ロックが解放(コミット or ロールバック)された後にSQLが実行される。</p></li>
<li><p>在庫数を減らすことに成功した場合は、
RDBMSの行ロックが取得され、他のトランザクションからの更新がロックされる。</p></li>
</ul>
<p>という動作になるため、データを安全に更新する事ができる。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>在庫数の減算処理(<code class="docutils literal notranslate"><span class="pre">quantity</span> <span class="pre">=</span> <span class="pre">quantity</span> <span class="pre">-</span> <span class="pre">#{quantity}</span></code>)は、SQLの中で行う。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>更新条件として、「在庫数が注文数以上ある事(<code class="docutils literal notranslate"><span class="pre">quantity</span> <span class="pre">&gt;=</span> <span class="pre">#{quantity}</span></code>)」を加える。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>Repositoryのメソッドを呼び出し、RDBMSの行ロック機能を使用してデータを安全に更新する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (5)</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">decrementQuantity</span><span class="p">(</span><span class="n">itemCode</span><span class="p">,</span><span class="w"> </span><span class="n">quantityOfOrder</span><span class="p">);</span>
<span class="c1">// (6)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (7)</span>
<span class="w">    </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span>
<span class="w">            </span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Not enough stock. Please, change quantity.&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>Repositoryのメソッドを呼び出し、更新処理を行う。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>Repositoryのメソッドの呼び出し結果を判定する。</p>
<p><code class="docutils literal notranslate"><span class="pre">false</span></code>の場合、更新条件を充たしていないため、在庫数が不足していることになる。</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>業務エラーを発生させる。</p>
<p>上記例では、ビジネスルールのチェック(在庫数チェック)を排他制御しながら行っているだけなので、
更新条件を充たさない場合は、排他エラーではなく業務エラーとしている。</p>
<p>発生させた業務エラーは、Controllerで適切にハンドリングすること。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id13">
<h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">6.3.2.1.2. </span>楽観ロック</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3では、ライブラリとして楽観ロックを行う仕組みは提供していない。</div>
<div class="line">そのため、楽観ロックを行う場合は、SQLの中でバージョンを意識する必要がある。</div>
</div>
<ul class="simple">
<li><p>Entityにバージョン管理用のプロパティを定義する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Stock</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemCode</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">quantity</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Entityにバージョン管理用のプロパティを用意する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>Repositoryインタフェースにメソッドを定義する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StockRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">Stock</span><span class="w"> </span><span class="nf">findByItemCode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">itemCode</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">updateQuantity</span><span class="p">(</span><span class="n">Stock</span><span class="w"> </span><span class="n">stock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>Repositoryインタフェースに、Entityを取得するためにメソッドを定義する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>Repositoryインタフェースに、楽観ロック機能を使ってデータを更新するメソッドを定義する。</p>
<p>上記例では、指定されたEntityの内容でレコードを更新するためのメソッドを定義している。
更新できた場合は、<code class="docutils literal notranslate"><span class="pre">true</span></code>が返却される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>マッピングファイルにSQLを定義する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findByItemCode&quot;</span><span class="w"> </span><span class="na">parameterType=</span><span class="s">&quot;string&quot;</span><span class="w"> </span><span class="na">resultType=</span><span class="s">&quot;Stock&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>item_code,
<span class="w">        </span>quantity,
<span class="w">        </span>version
<span class="w">    </span>FROM
<span class="w">        </span>m_stock
<span class="w">    </span>WHERE
<span class="w">        </span>item_code<span class="w"> </span>=<span class="w"> </span>#{itemCode}
<span class="nt">&lt;/select&gt;</span>

<span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;updateQuantity&quot;</span><span class="w"> </span><span class="na">parameterType=</span><span class="s">&quot;Stock&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>UPDATE
<span class="w">        </span>m_stock
<span class="w">    </span>SET
<span class="w">        </span>quantity<span class="w"> </span>=<span class="w"> </span>#{quantity},
<span class="w">        </span>/*<span class="w"> </span>(6)<span class="w"> </span>*/
<span class="w">        </span>version<span class="w"> </span>=<span class="w"> </span>version<span class="w"> </span>+<span class="w"> </span>1
<span class="w">    </span>WHERE
<span class="w">        </span>item_code<span class="w"> </span>=<span class="w"> </span>#{itemCode}
<span class="w">    </span>AND
<span class="w">        </span>/*<span class="w"> </span>(7)<span class="w"> </span>*/
<span class="w">        </span>version<span class="w"> </span>=<span class="w"> </span>#{version}
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>Entityを取得するためのステートメント(SQL)を定義する。</p>
<p>楽観ロックを使用する場合は、Entity取得時にバージョンを取得しておく必要がある。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>楽観ロック機能を使ってデータを更新するためのステートメント(SQL)を定義する。</p>
<p>上記例では、指定されたEntityの内容でレコードを更新するSQLを定義している。</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>バージョンの更新(<code class="docutils literal notranslate"><span class="pre">version</span> <span class="pre">=</span> <span class="pre">version</span> <span class="pre">+</span> <span class="pre">1</span></code>)は、SQLの中で行う。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>更新条件として、「バージョンが変わっていない事(<code class="docutils literal notranslate"><span class="pre">version</span> <span class="pre">=</span> <span class="pre">#{version}</span></code>)」を加える。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>Repositoryのメソッドを呼び出し、楽観ロック機能を使用してデータを安全に更新する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (8)</span>
<span class="n">Stock</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">findByItemCode</span><span class="p">(</span><span class="n">itemCode</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span>
<span class="w">            </span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Stock not found. itemCode : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">itemCode</span><span class="p">));</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// (9)</span>
<span class="n">stock</span><span class="p">.</span><span class="na">setQuantity</span><span class="p">(</span><span class="n">stock</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addedQuantity</span><span class="p">);</span>

<span class="c1">// (10)</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">updateQuantity</span><span class="p">(</span><span class="n">stock</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (11)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Stock</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">itemCode</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><p>RepositoryインタフェースのfindByItemCodeメソッドを呼び出し、Entityを取得する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><p>(8)で取得したEntityに対して、更新する値を指定する。</p>
<p>上記例では、仕入れた在庫数を加算している。</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><p>RepositoryインタフェースのupdateQuantityメソッドを呼び出し、
(8)の処理で更新したEntityを永続層(DB)に反映する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><p>更新結果を判定し、更新結果が<code class="docutils literal notranslate"><span class="pre">false</span></code>の場合は、
他のトランザクションによってEntityが更新されたことになるので、
楽観ロックエラー(<code class="docutils literal notranslate"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させる。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ロングトランザクションに対して楽観ロックを行う場合は、以下の点に注意すること。</p>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ロングトランザクションに対して楽観ロックを行う場合は、更新時のチェックとは別に、
データ取得時にもバージョンのチェックを行うこと。</p>
</div>
</div></blockquote>
<p>以下に、実装例を示す。</p>
<ul class="simple">
<li><p>データ取得時にもバージョンのチェックを行う。</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Stock</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">findByItemCode</span><span class="p">(</span><span class="n">itemCode</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">stock</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (12)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Stock</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">itemCode</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">stock</span><span class="p">.</span><span class="na">setQuantity</span><span class="p">(</span><span class="n">stock</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addedQuantity</span><span class="p">);</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">updateQuantity</span><span class="p">(</span><span class="n">stock</span><span class="p">);</span>
<span class="c1">// omitted</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(12)</div>
</div>
</td>
<td><p>別のデータベーストランザクションで取得したEntityのバージョンと、(8)で取得したEntityのバージョンを比較する。</p>
<p>バージョンが異なる場合は、他のトランザクションによってデータが更新されているので、楽観ロックエラー(<code class="docutils literal notranslate"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させる。</p>
<p>データが存在しない(<code class="docutils literal notranslate"><span class="pre">stock</span> <span class="pre">==</span> <span class="pre">null</span></code>)時の考慮も必要であり、アプリケーションの仕様に対応した実装を行う必要がある。上記例では、楽観ロックエラーとしている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>RDBMSの行ロック機能と楽観ロック機能を併用するアプリケーション場合は、以下の点に注意すること。</p>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>RDBMSの行ロック機能を利用して排他制御を行う処理と、
楽観ロック機能を利用して排他制御を行う処理が共存するアプリケーションの場合は、
RDBMSの行ロック機能を使うSQLの中で、<strong>バージョンの更新(インクリメント)が必要となる。</strong></p>
<p>仮にRDBMSの行ロック機能を使って排他制御を行うSQLの中でバージョンを更新しなかった場合、
楽観ロック機能を利用して排他制御を行っているSQLでデータを上書きしてしまう可能性がある。</p>
</div>
</div></blockquote>
<p>以下に、実装例を示す。</p>
<ul class="simple">
<li><p>SQL内でバージョンを更新する。</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;decrementQuantity&quot;</span><span class="nt">&gt;</span>
<span class="cp">&lt;![CDATA[</span>
<span class="cp">    UPDATE</span>
<span class="cp">        m_stock</span>
<span class="cp">    SET</span>
<span class="cp">        quantity = quantity - #{quantity},</span>
<span class="cp">        /* (13) */</span>
<span class="cp">        version = version + 1</span>
<span class="cp">    WHERE</span>
<span class="cp">        item_code = #{itemCode}</span>
<span class="cp">    AND</span>
<span class="cp">        quantity &gt;= #{quantity}</span>
<span class="cp">]]&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(13)</div>
</div>
</td>
<td><p>バージョンの更新(インクリメント)を行う。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id14">
<h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">6.3.2.1.3. </span>悲観ロック</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3では、ライブラリとして悲観ロックを行う仕組みは提供していない。</div>
<div class="line">そのため、悲観ロックを行う場合は、SQLの中でロックを取得するためのキーワードを指定する必要がある。</div>
</div>
<ul class="simple">
<li><p>SQLの中でロックを取得するためのキーワードを指定する</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findByItemCodeWithPessimisticLock&quot;</span><span class="w"> </span><span class="na">parameterType=</span><span class="s">&quot;string&quot;</span><span class="w"> </span><span class="na">resultType=</span><span class="s">&quot;Stock&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>item_code,
<span class="w">        </span>quantity,
<span class="w">        </span>version
<span class="w">    </span>FROM
<span class="w">        </span>m_stock
<span class="w">    </span>WHERE
<span class="w">        </span>item_code<span class="w"> </span>=<span class="w"> </span>#{itemCode}
<span class="w">    </span>/*<span class="w"> </span>(1)<span class="w"> </span>*/
<span class="w">    </span>FOR<span class="w"> </span>UPDATE
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>悲観ロックの取得が必要なSQLに対して、悲観ロックを取得するためのキーワードを指定する。</p>
<p>キーワードやキーワードの指定位置は、データベースによって異なる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="exclusioncontrolhowtouseexceptionhandling">
<span id="id15"></span><h3><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">6.3.2.2. </span>排他エラーのハンドリング方法</a><a class="headerlink" href="#exclusioncontrolhowtouseexceptionhandling" title="Permalink to this heading">¶</a></h3>
<section id="id16">
<h4><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">6.3.2.2.1. </span>楽観ロックの失敗時のエラーハンドリング</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h4>
<p>楽観ロックの失敗時には、<code class="docutils literal notranslate"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></code>が発生するため、
Controllerで適切にハンドリングする必要がある。</p>
<div class="line-block">
<div class="line">ハンドリング方法は、楽観ロックエラーが発生した時のアプリケーションの動作仕様によって異なる。</div>
</div>
<p>リクエスト単位に動作を変える必要がない場合は、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを使用してハンドリングする。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">OptimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="nf">handleOptimisticLockingFailureException</span><span class="p">(</span>
<span class="w">        </span><span class="n">OptimisticLockingFailureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">ExtendedModelMap</span><span class="w"> </span><span class="n">modelMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExtendedModelMap</span><span class="p">();</span>
<span class="w">    </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">resultMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">warning</span><span class="p">();</span>
<span class="w">    </span><span class="n">resultMessages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">setUpForm</span><span class="p">());</span>
<span class="w">    </span><span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">resultMessages</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">viewName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelAndView</span><span class="p">(</span><span class="n">viewName</span><span class="p">,</span><span class="w"> </span><span class="n">modelMap</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションのvalue属性に、<code class="docutils literal notranslate"><span class="pre">OptimisticLockingFailureException.class</span></code>を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラーハンドリングの処理を実装する。エラーを通知するためのメッセージ、画面表示に必要な情報（フォームやその他のモデル）を生成し、遷移先を指定した<code class="docutils literal notranslate"><span class="pre">ModelAndView</span></code>を返却する。</div>
<div class="line">エラーハンドリングの詳細については、<a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html#exception-handling-how-to-use-codingpoint-controller-usecase-label"><span class="std std-ref">ユースケース単位で例外をハンドリングする方法</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>リクエスト単位に動作を変える必要がある場合は、Controllerのハンドラメソッドの中で、<code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">catch</span></code>を使用してハンドリングする。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;{itemId}/update&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">StockForm</span><span class="w"> </span><span class="n">form</span><span class="p">,</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">RedirectAttributes</span><span class="w"> </span><span class="n">attributes</span><span class="p">){</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stockService</span><span class="p">.</span><span class="na">update</span><span class="p">(...);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">OptimisticLockingFailureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">resultMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">warning</span><span class="p">();</span>
<span class="w">        </span><span class="n">resultMessages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">resultMessages</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">updateRedo</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">OptimisticLockingFailureException</span></code> をcatchする。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラーハンドリングの処理を実装する。エラーを通知するためのメッセージ、画面表示に必要な情報（フォームやその他のモデル）を生成し、遷移先のview名を返却する。</div>
<div class="line">エラーハンドリングの詳細については、<a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html#exception-handling-how-to-use-codingpoint-controller-request-label"><span class="std std-ref">リクエスト単位で例外をハンドリングする方法</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id17">
<h4><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">6.3.2.2.2. </span>悲観ロックの失敗時のエラーハンドリング</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h4>
<p>悲観ロックの失敗時には、<code class="docutils literal notranslate"><span class="pre">org.springframework.dao.PessimisticLockingFailureException</span></code>が発生するため、 Controllerで適切にハンドリングする必要がある。</p>
<p>ハンドリング方法は、悲観ロックエラーが発生した時のアプリケーションの動作仕様によって異なる。</p>
<p>リクエスト単位に動作を変える必要がない場合は、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを使用してハンドリングする。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">PessimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="nf">handlePessimisticLockingFailureException</span><span class="p">(</span>
<span class="w">        </span><span class="n">PessimisticLockingFailureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">ExtendedModelMap</span><span class="w"> </span><span class="n">modelMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExtendedModelMap</span><span class="p">();</span>
<span class="w">    </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">resultMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">warning</span><span class="p">();</span>
<span class="w">    </span><span class="n">resultMessages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">setUpForm</span><span class="p">());</span>
<span class="w">    </span><span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">resultMessages</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">viewName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelAndView</span><span class="p">(</span><span class="n">viewName</span><span class="p">,</span><span class="w"> </span><span class="n">modelMap</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションのvalue属性に、<code class="docutils literal notranslate"><span class="pre">PessimisticLockingFailureException.class</span></code>を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラーハンドリングの処理を実装する。エラーを通知するためのメッセージ、画面表示に必要な情報（フォームやその他のモデル）を生成し、遷移先を指定した<code class="docutils literal notranslate"><span class="pre">ModelAndView</span></code>を返却する。</div>
<div class="line">エラーハンドリングの詳細については、<a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html#exception-handling-how-to-use-codingpoint-controller-usecase-label"><span class="std std-ref">ユースケース単位で例外をハンドリングする方法</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>リクエスト単位に動作を変える必要がある場合は、Controllerのハンドラメソッドの中で、<code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">catch</span></code>を使用してハンドリングする。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;{itemId}/update&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">StockForm</span><span class="w"> </span><span class="n">form</span><span class="p">,</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">RedirectAttributes</span><span class="w"> </span><span class="n">attributes</span><span class="p">){</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stockService</span><span class="p">.</span><span class="na">update</span><span class="p">(...);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">PessimisticLockingFailureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">resultMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">warning</span><span class="p">();</span>
<span class="w">        </span><span class="n">resultMessages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span><span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">resultMessages</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">updateRedo</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">PessimisticLockingFailureException</span></code>をcatchする。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラーハンドリングの処理を実装する。エラーを通知するためのメッセージ、画面表示に必要な情報（フォームやその他のモデル）を生成し、遷移先のview名を返却する。</div>
<div class="line">エラーハンドリングの詳細については、<a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html#exception-handling-how-to-use-codingpoint-controller-request-label"><span class="std std-ref">リクエスト単位で例外をハンドリングする方法</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../GeneralFuncDetail/index.html" title="7. アプリケーション形態に依存しない汎用機能"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. データベースアクセス（MyBatis3編）"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Server Framework (1.x) Development Guideline 1.8.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">6. </span>データアクセス</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.3. </span>排他制御</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, NTT Corporation.
      Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 7.1.2.Theme is <a href="https://pypi.org/project/solar-theme/">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>